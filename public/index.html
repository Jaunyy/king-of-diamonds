<!DOCTYPE html>
<html>
<head>
    <title>King of Diamonds Game</title>
    <style>
        body {
            padding: 0;
            margin: 0;
            font-family: Arial, sans-serif;
            align-items: center;
            background: linear-gradient(to bottom right, #2c3e50, #3498db);
            color: white;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        #bottomContainer {
            position: absolute;
            left: 50%;
            bottom: 0px;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        #selected {
            font-size: 1.2em;
            transform: translateY(-300%);
            color: white;
            justify-content: center;
        }

        h1 {
            text-align: center;
            margin-top: 20px;
            font-size: 3em;
        }

        #joinScreen {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        #popup {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            justify-content: center;
            align-items: center;
        }

        #gridContainer {
            background-color: rgb(0, 0, 0);
            padding: 20px;
            border-radius: 12px;
            display: grid;
            grid-template-columns: repeat(10, 50px);
            grid-template-rows: repeat(11, 50px);
            gap: 5px;
        }

        #waitingForPlayers {
            position: absolute;
            top: 300px;         /* distance from top */
            left: 50%;         /* center horizontally */
            transform: translateX(-50%); /* truly center */
            font-size: 1.2em;
            text-align: center;
        }


        .cell {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #ffffff;
            border: 1px solid #ccc;
            cursor: pointer;
            color: rgb(0, 0, 0);
        }
   
        .player {
            position: absolute;
            padding: 6px 20px; /* balanced space left/right */
            border-radius: 20px;
            text-align: center;
            background: rgba(255,255,255,0.1);
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }

        .cell.clicked { background: #add8e6; cursor: default; }
        #closePopup { margin-top: 10px; }

        h1 { text-align: center; margin-top: 20px; font-size: 3em; }
        #players { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        
        #chooseNumberBtn {
            margin-bottom: 20px;
            width: 700px;
            padding: 10px 20px;
            font-size: 1.2em;
            border: none;
            border-radius: 10px;
            background: #554948;
            color: white;
            cursor: pointer;
            transition: background 0.3s;
        }

        #pickNumText {
            display: none; 
            margin-top: 300px; 
        }

        #startRoundBtn {
            position: absolute;
            bottom: 350px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 3em;
            cursor: pointer;  
            display: none; 
            width: auto;
            text-align: center;
            background: #c0392b; 
            padding: 20px;
            border-radius: 20px;
        }

        #winner { margin-top: 20px; font-size: 1.5em; text-shadow: 2px 2px 4px black; }
        #eliminations { margin-top: 20px; list-style: none; padding: 0; }
        #eliminations li { background: rgba(255,0,0,0.2); padding: 5px 10px; margin: 5px 0; border-radius: 6px; }
    </style>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>
    <div id="joinScreen">
        <h1>King of Diamonds</h1>
        <h2>Enter your name to join:</h2>
        <input type="text" id="playerNameInput" placeholder="Your name">
        <button id="joinBtn">Join Game</button>
    </div>

    <div id="gameScreen" style="display: none;">
        <h1 id="countdownTimer" style="display:none; text-align:center; font-size:48px;"></h1>
        <h2 id="waitingForPlayers"></h2>
        <div id="players">
            <div id="p1" class="player">
                <div class="playerName"></div>
                <div class="status"></div>
                <div class="playerScore"></div>
            </div>
            <div id="p2" class="player">
                <div class="playerName"></div>
                <div class="status"></div>
                <div class="playerScore"></div>
            </div>
            <div id="p3" class="player">
                <div class="playerName"></div>
                <div class="status"></div>
                <div class="playerScore"></div>
            </div>
            <div id="p4" class="player">
                <div class="playerName"></div>
                <div class="status"></div>
                <div class="playerScore"></div>
            </div>
        </div>
        <div id="bottomContainer">
            <div id="selected">Selected Number: None</div>
            <button id="chooseNumberBtn">Choose Number</button>
        </div>
        <div id="popup">
            <div>
                <div id="gridContainer"></div>
                <button id="closePopup">Close</button>
            </div>
        </div>
        <h2 id="pickNumText">Pick a number then press Start</h2>
        <div id="startRoundBtn">Start!</div>
    </div>
    
    <script>
        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyD0WlA_2IEzYwavt_Dtm6NUr_vu2kpuvaU",
            authDomain: "kingofdiamonds-c5967.firebaseapp.com",
            databaseURL: "https://kingofdiamonds-c5967-default-rtdb.firebaseio.com",
            projectId: "kingofdiamonds-c5967",
            storageBucket: "kingofdiamonds-c5967.appspot.com",
            messagingSenderId: "872745210340",
            appId: "1:872745210340:web:be3f6bf228dcac81c9f7f1",
            measurementId: "G-LMNG7S6E6H"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const startRoundBtn = document.getElementById('startRoundBtn');
        const joinScreen = document.getElementById('joinScreen');
        const gameScreen = document.getElementById('gameScreen');
        const joinBtn = document.getElementById('joinBtn');
        const popup = document.getElementById('popup');
        const gridContainer = document.getElementById('gridContainer');
        const selectedDiv = document.getElementById('selected');
        const chooseNumberBtn = document.getElementById('chooseNumberBtn');
        const closeBtn = document.getElementById('closePopup');

        chooseNumberBtn.addEventListener('click', () => {
            popup.style.display = 'flex';
        });

        // Assigning Player ID's once logged on
        let myPlayerID = null;
        let myName = null;
        let moves = {};


        let playerTags = {};
        joinBtn.addEventListener('click', () => {
            myName = document.getElementById("playerNameInput").value.trim();
            if (!myName) {
                alert("Please enter your name");
                return;
            }
            db.ref("players").once("value").then(snapshot => {
                let players = snapshot.val() || {};
                let playerCount = Object.keys(players).length;
                if (playerCount >= 4) {
                    alert("Game full (four players maximum)");
                    return;
                }

                for (let i = 1; i <= 4; i++) {
                    if (!players[`p${i}`]) {
                        myPlayerID = `p${i}`;
                        playerTags[myPlayerID] = myName;
                        db.ref("players/" + myPlayerID).set({ name: myName, joined: true});
                        db.ref("players/" + myPlayerID).onDisconnect().remove();
                        break;
                    }
                }
                joinScreen.style.display = "none";
                gameScreen.style.display = "block";
            })
        })

        let chosenCount = 0;

        startRoundBtn.addEventListener('click', () => {
            if (chosenCount === 4) {
                db.ref("game/roundStartTime").once("value").then(snapshot => {
                    if (!snapshot.exists()) {
                        db.ref("game/roundStartTime").set(firebase.database.ServerValue.TIMESTAMP);
                    }
                });
            }
        }); 

        const countdownTimer = document.getElementById("countdownTimer");
        let timerInterval = null; // keep reference to clear it

        db.ref("game/roundStartTime").on("value", snapshot => {
            const startTime = snapshot.val();
            if (!startTime) return;

            countdownTimer.style.display = "block";

            const duration = 10000; // 10 seconds

            if (timerInterval) clearInterval(timerInterval);

            timerInterval = setInterval(() => {
                const now = Date.now();
                const elapsed = now - startTime;
                const remaining = Math.max(0, duration - elapsed);

                countdownTimer.textContent = Math.ceil(remaining / 1000);

                if (remaining <= 0) {
                    clearInterval(timerInterval);
                    countdownTimer.textContent = "GO!";
                    playGame(); // run your round logic
                }
            }, 250);
        });

        let number = 0;
        let prevcell = null;
        for (let i = 0; i < 110; i++) {
            const cell = document.createElement('div');
            cell.classList.add('cell');

            if (i < 9) {
                cell.classList.add('black'); // first 9 are black fillers
                cell.style.pointerEvents = "none"; // make them unclickable
            } else {
                cell.textContent = number;
                cell.dataset.number = number;

                cell.addEventListener('click', () => {
                    if (prevcell) prevcell.classList.remove('clicked');
                    prevcell = cell;
                    cell.classList.add('clicked');
                    selectedDiv.textContent = `Number Selected: ${cell.dataset.number}`;
                    selectedDiv.dataset.number = cell.dataset.number;
                    // Save locally
                    moves[myPlayerID] = Number(cell.dataset.number);
                    // Push to Firebase
                    db.ref("moves/" + myPlayerID).set({name: myName, move: Number(cell.dataset.number)});
                    db.ref("moves/" + myPlayerID).onDisconnect().remove();
                    // Update local UI immediately
                    const myDiv = document.getElementById(myPlayerID);
                    const statusDiv = myDiv.querySelector(".status");
                    if (statusDiv) statusDiv.textContent = "Has chosen!";
                    popup.style.display = 'none';
                });

                number++;
            }
            gridContainer.appendChild(cell);
        }

        // Listen for changes in Firebase moves
        db.ref("moves").on("value", snapshot => {
            const movesData = snapshot.val() || {};
            moves = {}; // reset local moves

            // Build moves object: playerID -> number
            Object.keys(movesData).forEach(playerID => {
                moves[playerID] = movesData[playerID].move;
            });

            // Update player statuses
            Object.keys(playerTags).forEach(playerID => {
                const playerDiv = document.getElementById(playerID);
                if (!playerDiv) return;
                const statusDiv = playerDiv.querySelector(".status");
                if (!statusDiv) return;

                if (moves[playerID] !== undefined) {
                    statusDiv.textContent = "Has chosen!";
                } else {
                    statusDiv.textContent = "Choosing...";
                }
            });
            chosenCount = Object.keys(moves).length;
            startRoundBtn.style.display = (chosenCount === 4) ? "block" : "none";
        });

        closeBtn.addEventListener('click', () => {
            popup.style.display = 'none';
        });

        const KINGS_NUMBER = 0.8;
        let scores = {};
        let eliminated = [];

        // Listen for score changes from Firebase
        db.ref('scores').on('value', snapshot => {
            const firebaseScores = snapshot.val();
            if (firebaseScores) {
                scores = firebaseScores;
                updateScores();
            }
        });

        // Listen for eliminations
        db.ref('eliminated').on('value', snapshot => {
            const firebaseElim = snapshot.val();
            if(firebaseElim) {
                eliminated = firebaseElim;
                const elimList = document.getElementById("eliminations");
                elimList.innerHTML = '';
                eliminated.forEach(name => {
                    const li = document.createElement("li");
                    li.textContent = name + " has been eliminated!";
                    elimList.appendChild(li);
                });
            }
        });
        
        const missingList = document.getElementById("waitingForPlayers");
        const OGpositions = [
            { top: "20px", left: "50%", transform: "translateX(-50%)"},   // top center
            { top: "44.6%", right: "40px" }, // right side
            { top: "44.6%", left: "40px" }   // left side
        ];

        // Keep playerTags updated with all joined players
        db.ref("players").on("value", snapshot => {
            const players = snapshot.val() || {};
            playerTags = {}; // reset

            Object.keys(players).forEach(pid => {
                playerTags[pid] = players[pid].name;
            });

            // Update player UI
            Object.keys(playerTags).forEach(pid => {
                const playerDiv = document.getElementById(pid);
                if (!playerDiv) return;
                const nameDiv = playerDiv.querySelector(".playerName");
                if (nameDiv) nameDiv.textContent = playerTags[pid];
            });
        });

        db.ref("players").on("value", snapshot => {
            const players = snapshot.val() || {};
            const playerCount = Object.keys(players).length;
            let positions = OGpositions.slice();

            for (let i = 1; i <= 4; i++) {
                const playerID = `p${i}`;
                const playerDiv = document.getElementById(`p${i}`);

                if (players[playerID]) {
                    const nameDiv = playerDiv.querySelector(".playerName");
                    const statusDiv = playerDiv.querySelector(".status");
                    const scoreDiv = playerDiv.querySelector(".playerScore");

                    // Set player name
                    if (nameDiv) nameDiv.textContent = players[playerID].name;

                    // Initialize status and score if empty
                    if (statusDiv) statusDiv.textContent = "Choosing...";
                    if (scoreDiv) scoreDiv.textContent = "Score: " + (scores[players[playerID].name] || 0);

                    playerDiv.style.visibility = "visible";

                    if (playerID === myPlayerID) {
                        playerDiv.style.bottom = "70px";
                        playerDiv.style.left = "50%";  // centered
                        playerDiv.style.transform = "translateX(-50%)";
                    } else {
                        const pos = positions.shift();
                        playerDiv.style.bottom = pos.bottom || '';
                        playerDiv.style.left = pos.left || '';
                        playerDiv.style.right = pos.right || '';
                        playerDiv.style.top = pos.top || '';
                        playerDiv.style.transform = pos.transform || "";
                    }
                } else {
                    playerDiv.style.visibility = "hidden";

                    const nameDiv = playerDiv.querySelector(".playerName");
                    if (nameDiv) nameDiv.textContent = "";

                    const statusDiv = playerDiv.querySelector(".status");
                    if (statusDiv) statusDiv.textContent = "";

                    playerDiv.removeAttribute("style");
                    delete playerTags[playerID];
                }
            }

            // Waiting message
            if (playerCount < 4) {
                missingList.textContent = "Waiting for " + (4 - playerCount) + " more player(s)";
                pickNumText.style.display = 'none';
            } else {
                missingList.textContent = "";
                pickNumText.style.display = 'block';
                startRoundBtn.style.display = 'block';
            }
        });

        function findWinner(playerMoves){
            let total = 0;
            const names = Object.keys(playerMoves);
            names.forEach (name => total += playerMoves[name]);
            const result = (total / names.length)  *  KINGS_NUMBER;

            let minDiff = Infinity;
            let winner = "";
            names.forEach (name => {
                const diff = Math.abs(playerMoves[name] - result);
                if (diff < minDiff) {minDiff = diff; winner = name;}
            });
            handleLosses(playerMoves, winner);
            if (eliminated.length == 3 && !eliminated.includes(winner)){
                const listWinner = document.createElement("p");
                listWinner.textContent = "Congratulations " + winner + " you defeated the King of Diamonds!";
                document.body.appendChild(listWinner);
                eliminated.push(winner);
                db.ref('eliminated').set(eliminated);
            }
            return winner;
        }

        function handleLosses(playerMoves, winner){
            const names = Object.keys(playerMoves);
            names.forEach(name =>{
                if (name !== winner && !eliminated.includes(name)){
                    if (!(name in scores)) scores[name] = 0;
                    scores[name] -= 1;
                    if (scores[name] <= -10){
                        eliminated.push(name);
                        db.ref('eliminated').set(eliminated);
                    }
                }
            });
            db.ref('scores').set(scores);  // Update scores in Firebase
            updateScores();
        }

        function resetGame() {
            // Reset local state
            scores = {};
            eliminated = [];

            // Clear Firebase data
            db.ref('scores').set({});
            db.ref('eliminated').set([]);
            db.ref('moves').set({});

            // Reset UI elements
            document.getElementById("winner").innerText = "";
            document.getElementById("eliminations").innerHTML = "";
            selectedDiv.textContent = "Selected Number: None";

            // Reset player bubbles dynamically
            if (playerTags) {
                Object.keys(playerTags).forEach(tag => {
                    const playerDiv = document.getElementById(tag);
                    if (playerDiv) {
                        let scoreDiv = playerDiv.querySelector(".playerScore");
                        if (!scoreDiv) {
                            scoreDiv = document.createElement("div");
                            scoreDiv.classList.add("playerScore");
                            playerDiv.appendChild(scoreDiv);
                        }
                        scoreDiv.textContent = "Score: 0";
                    }
                });
            }
        }

       function playGame() {
            db.ref("moves").once("value").then(snapshot => {
                const movesData = snapshot.val() || {};
                let playerMoves = {};
                Object.values(movesData).forEach(moveObj => {
                    if (moveObj.move !== undefined && moveObj.name) {
                        playerMoves[moveObj.name] = moveObj.move;
                    }
                });

                const winner = findWinner(playerMoves);
                document.getElementById("winner").innerText = "Winner of the Round: " + winner;

                // Clear moves for next round
                db.ref("moves").set({});
            });
        }


        function updateScores() {
            const tags = Object.keys(playerTags); 
            tags.forEach(tag => {
                const playerName = playerTags[tag];       // get player name
                const playerDiv = document.getElementById(tag);   // convert "player1" → "p1"
                if (!playerDiv) return;
                
                let scoreDiv = playerDiv.querySelector(".playerScore");
                if (!scoreDiv) {
                    scoreDiv = document.createElement("div");
                    scoreDiv.classList.add("playerScore");
                    playerDiv.appendChild(scoreDiv);
                }
                scoreDiv.textContent = "Score: " + (scores[playerName] || 0);
            });
        }


    </script>
</body>
</html>
